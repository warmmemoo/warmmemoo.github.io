<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Maintenance Report</title>
  <style>
    /* ===== Comfort profile for mobile-first ===== */
    :root{
      /* ‚Üì ‡∏¢‡πà‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ (‡∏Ç‡πâ‡∏≠ 2) */
      --body-size: clamp(16px, 0.85rem + 1.4vw, 19px);
      --h1-size: clamp(21px, 0.95rem + 2.6vw, 25px);
      --h2-size: clamp(19px, 0.9rem + 2.0vw, 22px);

      --label-size: clamp(14px, 0.8rem + 0.5vw, 16px);
      --note-size: clamp(12px, 0.75rem + 0.35vw, 15px);

      --control-size: clamp(15px, 0.85rem + 1.0vw, 18px);
      --button-size: clamp(14px, 0.8rem + 0.9vw, 17px);

      --control-pad-y: 12px; --control-pad-x: 14px;
      --button-pad-y: 11px; --button-pad-x: 16px;

      --bg:#e9f7ef; --text:#111; --card:#fff; --border:#e5e7eb; --shadow:0 10px 24px rgba(0,0,0,.06);
      --safe-b: env(safe-area-inset-bottom, 0px);

      --page-gutter: clamp(4px, 1.2vw, 12px);
      --card-max: 680px;
    }

    html,body{height:100%}
    body{
      margin:0; padding:0; background:var(--bg); color:var(--text);
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif;
      line-height:1.6; -webkit-text-size-adjust:100%;
      font-size: var(--body-size);
    }

    .container{
      width: calc(100vw - 2*var(--page-gutter));
      max-width: var(--card-max);
      margin: 8px auto 16px;
      padding: 0 var(--page-gutter);
    }
    .section{ margin-bottom: 10px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:18px;
      box-shadow:var(--shadow); padding:18px;
    }

    h1{ margin:0 0 6px; font-size: var(--h1-size); }
    h2{ margin:0 0 10px; font-size: var(--h2-size); }

    label{ display:block; font-weight:700; margin-bottom:8px; font-size: var(--label-size); }
    .note{ font-size: var(--note-size); color:#333; opacity:.95 }

    select, textarea, input[type="text"], input[type="time"]{
      width:100%;
      border:1.6px solid var(--border);
      border-radius:14px;
      padding: var(--control-pad-y) var(--control-pad-x);
      font-size: var(--control-size);
      background:#fff; color:var(--text);
      outline:none;
    }
    textarea{ min-height: 140px; resize: vertical; }

    .grid2{ display:grid; gap:10px; grid-template-columns: 1fr; }
    @media(min-width:520px){ .grid2{ grid-template-columns: 1fr 1fr; align-items:end; } }

    .time-row{ display:grid; grid-template-columns: 1fr auto 1fr; gap:8px; align-items:center; }
    .time-sep{ text-align:center; font-weight:700; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      border:1px solid var(--border); border-radius:999px;
      padding:10px 14px; background:#fff; font-size:0.96em;
    }

    .file{ border:1.6px dashed #bdbdbd; border-radius:14px; padding:16px; background:#fafafa; }

    .summary{ display:grid; gap:10px; }
    .sum-row{ display:flex; gap:8px; align-items:flex-start; }
    .sum-label{ min-width:140px; font-weight:900; }
    .sum-val{ flex:1; white-space:pre-wrap; word-break:break-word; }
    @media(max-width:420px){ .sum-label{ min-width:120px; } }

    .photo-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:6px; }
    .photo-grid img{
      width:100%; aspect-ratio:1/1; object-fit:cover;
      border-radius:10px; border:1px solid var(--border); background:#fff;
    }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; justify-content:center; }
    button{
      border:1.6px solid #111; color:#111; background:#fff;
      border-radius:14px;
      padding: var(--button-pad-y) var(--button-pad-x);
      font-weight:900; cursor:pointer; font-size: var(--button-size);
      touch-action:manipulation;
    }
    button:hover{ filter:brightness(0.97); }

    .sticky{
      position:sticky; bottom:0; z-index:5;
      background:linear-gradient(to top, rgba(233,247,239,0.98), rgba(233,247,239,0.6));
      border-top:1px solid var(--border);
      padding:12px 12px calc(12px + var(--safe-b));
      margin:8px -12px -12px; backdrop-filter: blur(6px);
      border-bottom-left-radius:18px; border-bottom-right-radius:18px;
    }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{
      width:min(94vw, 520px); background:#fff; color:#111; border-radius:16px; border:1px solid var(--border);
      box-shadow:0 20px 50px rgba(0,0,0,.25); padding:18px; text-align:center; font-size: 0.96em;
    }
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #e6e6e6; background:#f7f7f7; margin-bottom:8px; }
    .hidden{ display:none; }
    .ok{ border-color:#16a34a; background:#dcfce7; }
    .err{ border-color:#ef4444; background:#fee2e2; }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    .card { contain: layout; }
    textarea { overflow:auto; -webkit-overflow-scrolling:touch; word-break:break-word; overflow-wrap:anywhere; }
  </style>
</head>
<body>
  <div class="container">
    <form id="reportForm">
      <div class="section card">
        <h1>Maintenance Report</h1>
      </div>

      <!-- 1) Purpose + Working time -->
      <div class="section card">
        <h2>1) Heading (Purpose) &emsp;&emsp;&emsp;&emsp;Working time</h2>
        <div class="grid2">
          <div>
            <select id="subject" name="subject" required>
              <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå --</option>
              <option>Check</option>
              <option>Improvement</option>
              <option>Repair</option>
              <option>Trial</option>
              <option>PM</option>
            </select>
          </div>
          <div>
            <div class="time-row">
              <input type="time" id="wtStart" step="60" aria-label="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°">
              <div class="time-sep">‡∏ñ‡∏∂‡∏á</div>
              <input type="time" id="wtEnd" step="60" aria-label="‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö">
            </div>
          </div>
        </div>
      </div>

      <!-- 2) Line -->
      <div class="section card">
        <h2>2) Production line</h2>
        <select id="lineSel" required>
          <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>
        </select>
      </div>

      <!-- 3) Sub-line -->
      <div class="section card">
        <h2>3) Sub-line</h2>
        <select id="subSel" required disabled>
          <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Production line ‡∏Å‡πà‡∏≠‡∏ô</option>
        </select>
      </div>

      <!-- 4) Tooling -->
      <div class="section card">
        <h2>4) Tooling list</h2>
        <select id="toolSel" disabled>
          <option value="" selected>‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
        </select>
      </div>

      <!-- 5) Machine -->
      <div class="section card">
        <h2>5) Machine list</h2>
        <select id="machineSel" disabled>
          <option value="" selected>‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
        </select>
      </div>

      <!-- 6) Problem -->
      <div class="section card">
        <h2>6) The Problem Causes</h2>
        <textarea id="problem" name="problem" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." required></textarea>
      </div>

      <!-- 7) Action + ‡∏£‡∏π‡∏õ -->
      <div class="section card">
        <h2>7) Solved Action & ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ</h2>
        <textarea id="action" name="action" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..." required></textarea>

        <div style="margin-top:16px;">
          <div class="file">
            <input id="mediaPicker" type="file" accept="image/*" multiple style="display:none;">
            <div class="row" style="margin:6px 0 4px;">
              <button type="button" id="btnCamera" class="pill">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢</button>
              <button type="button" id="btnGallery" class="pill">üîó ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏π‡∏õ</button>
              <button type="button" id="btnClearPhotos" class="pill">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ</button>
            </div>
            <div class="note">‡πÅ‡∏ô‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏£‡∏π‡∏õ ‚Äî ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
          </div>
        </div>
      </div>

      <!-- 8) ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á -->
      <div class="section card">
        <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h2>
        <div class="summary">
          <div class="sum-row"><div class="sum-label">Purpose</div><div class="sum-val" id="sum_subject">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Working time</div><div class="sum-val" id="sum_wtime">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Production line</div><div class="sum-val" id="sum_line">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Sub-line</div><div class="sum-val" id="sum_sub">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Tooling</div><div class="sum-val" id="sum_tool">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Machine</div><div class="sum-val" id="sum_machine">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Problem</div><div class="sum-val" id="sum_problem">‚Äî</div></div>
          <div class="sum-row"><div class="sum-label">Action</div><div class="sum-val" id="sum_action">‚Äî</div></div>

          <div class="photo-grid" id="sum_photos" style="display:none;"></div>
          <div class="note" id="sum_photoNote">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ: ‚Äî</div>
        </div>

        <div class="sticky">
          <div class="actions">
            <button type="submit" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="reset" id="resetBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- MODAL -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <span id="modalBadge" class="badge ok">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
      <h3 id="modalTitle">üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üÜó</h3>
      <p id="modalMsg">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ Lets go</p>
      <div class="row" style="justify-content:center; gap:10px;">
        <button id="newForm" class="pill">‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
        <button id="closeModal" class="pill">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);

  /* ===== Modal ===== */
  const modal = $('#modalBackdrop');
  $('#closeModal').addEventListener('click', ()=> modal.style.display='none');
  $('#newForm').addEventListener('click', ()=>{
    modal.style.display='none';
    document.getElementById('reportForm').reset();
    hardResetUI();
  });
  function showModal({ ok, title, message } = {}){
    $('#modalBadge').className = 'badge ' + (ok ? 'ok' : 'err');
    if (typeof title === 'string')  $('#modalTitle').textContent = title;
    if (typeof message === 'string')$('#modalMsg').textContent   = message;
    modal.style.display = 'flex';
    modal.addEventListener('click', e=>{ if (e.target===modal) modal.style.display='none'; }, { once:true });
    document.addEventListener('keydown', e=>{ if (e.key==='Escape') modal.style.display='none'; }, { once:true });
  }

  /* ===== LOOKUP maps ===== */
  let LOOKUP=[], SUBS_BY_LINE={}, TOOLS_BY_PAIR={}, MACHINES_BY_TRIPLE={}, MACHINES_BY_PAIR={}, TOOLS_BY_MACHINE_TRIPLE={};
  const k2=(l,s)=>`${l}||${s}`, k3=(l,s,t)=>`${l}||${s}||${t}`, km=(l,s,m)=>`${l}||${s}||${m}`;
  const uniq = a=>Array.from(new Set(a));
  const normStr = s => String(s||'').trim();
  const hasValue = (arr, val) => (arr||[]).some(x => normStr(x) === normStr(val));

  // fillSelect: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (allowNone=true)
  function fillSelect(id, items, ph, {allowNone=false, disabledWhenEmpty=true} = {}){
    const sel = document.getElementById(id);
    sel.innerHTML='';
    if (!items || !items.length){
      const o0=document.createElement('option');
      o0.value=''; o0.disabled=true; o0.selected=true; o0.textContent=ph||'-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --';
      sel.appendChild(o0);
      sel.disabled = !!disabledWhenEmpty;
      return;
    }
    const o0=document.createElement('option');
    o0.value=''; o0.disabled=true; o0.selected=true; o0.textContent=ph||'-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --';
    sel.appendChild(o0);
    if (allowNone){
      const on=document.createElement('option');
      on.value=''; on.textContent='‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî';
      sel.appendChild(on);
    }
    items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    sel.disabled = false;
  }

  function initLookups(res){
    if (!res || !res.ok){
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res && res.message ? res.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
      fillSelect('lineSel', [], '‚Äî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏™‡∏ï‡πå ‚Äî');
      return;
    }
    LOOKUP = res.lines||[];
    SUBS_BY_LINE={}; TOOLS_BY_PAIR={}; MACHINES_BY_TRIPLE={}; MACHINES_BY_PAIR={}; TOOLS_BY_MACHINE_TRIPLE={};

    LOOKUP.forEach(g=>{
      const line=g.line, subs=g.subs||[];
      SUBS_BY_LINE[line]=subs.map(s=>s.sub);
      subs.forEach(s=>{
        const sub=s.sub, tools=s.toolings||[];
        TOOLS_BY_PAIR[k2(line,sub)] = tools;

        // ‡∏£‡∏ß‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå (‡∏£‡∏ß‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á '') ‡πÅ‡∏•‡∏∞ map ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tooling ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠
        const mbt = s.machinesByTool || {};   // { [toolName or '']: string[] }
        let union = [];
        Object.keys(mbt).forEach(tKey=>{
          const list = Array.isArray(mbt[tKey]) ? mbt[tKey] : [];
          union = union.concat(list);
          if (tKey){
            MACHINES_BY_TRIPLE[k3(line,sub,tKey)] = list;
            list.forEach(m=>{
              const key = km(line,sub,m);
              if(!TOOLS_BY_MACHINE_TRIPLE[key]) TOOLS_BY_MACHINE_TRIPLE[key] = [];
              TOOLS_BY_MACHINE_TRIPLE[key].push(tKey);
            });
          }
        });
        MACHINES_BY_PAIR[k2(line,sub)] = uniq(union).sort();
      });
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ line
    fillSelect('lineSel', LOOKUP.map(x=>x.line), '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Production line --');
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå/‡∏õ‡∏¥‡∏î sub/tool/machine
    fillSelect('subSel', [], '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Production line ‡∏Å‡πà‡∏≠‡∏ô');
    fillSelect('toolSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
    fillSelect('machineSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
    updateSummary();
  }

  function syncToolByMachine(){
    const line = document.getElementById('lineSel').value;
    const sub  = document.getElementById('subSel').value;
    const mach = document.getElementById('machineSel').value;
    const toolSelEl = document.getElementById('toolSel');
    const prevTool  = toolSelEl.value;

    if (!line || !sub){
      fillSelect('toolSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
      return;
    }
    if (mach){
      const list = TOOLS_BY_MACHINE_TRIPLE[km(line,sub,mach)] || [];
      fillSelect('toolSel', list, list.length ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tooling --' : '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ Tooling ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‚Äî',
                 {allowNone:true, disabledWhenEmpty:false});
      if (prevTool && hasValue(list, prevTool)) toolSelEl.value = prevTool;
    } else {
      const list = TOOLS_BY_PAIR[k2(line,sub)] || [];
      fillSelect('toolSel', list, list.length ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tooling --' : '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî',
                 {allowNone:true, disabledWhenEmpty:list.length===0});
      if (prevTool && hasValue(list, prevTool)) toolSelEl.value = prevTool;
    }
  }

  function syncMachineByTool(){
    const line = document.getElementById('lineSel').value;
    const sub  = document.getElementById('subSel').value;
    const tool = document.getElementById('toolSel').value;
    const machSelEl = document.getElementById('machineSel');
    const prevMach  = machSelEl.value;

    if (!line || !sub){
      fillSelect('machineSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
      return;
    }
    if (tool){
      const list = MACHINES_BY_TRIPLE[k3(line,sub,tool)] || [];
      fillSelect('machineSel', list, list.length ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Machine --' : '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tooling ‡∏ô‡∏µ‡πâ ‚Äî',
                 {allowNone:true, disabledWhenEmpty:list.length===0});
      if (prevMach && hasValue(list, prevMach)) machSelEl.value = prevMach;
    } else {
      const list = MACHINES_BY_PAIR[k2(line,sub)] || [];
      fillSelect('machineSel', list, list.length ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --' : '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî',
                 {allowNone:true, disabledWhenEmpty:list.length===0});
      if (prevMach && hasValue(list, prevMach)) machSelEl.value = prevMach;
    }
  }

  /* ===== DOM Ready ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    google.script.run.withSuccessHandler(initLookups).getLookups();

    const lineSel=$('#lineSel'), subSel=$('#subSel'), toolSel=$('#toolSel'), machineSel=$('#machineSel');

    lineSel.addEventListener('change', ()=>{
      const line=lineSel.value;
      fillSelect('subSel', SUBS_BY_LINE[line]||[], '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sub-line --');
      fillSelect('toolSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
      fillSelect('machineSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
      updateSummary();
    });

    subSel.addEventListener('change', ()=>{
      const line=lineSel.value, sub=subSel.value;
      fillSelect('toolSel', TOOLS_BY_PAIR[k2(line,sub)]||[], '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tooling --', {allowNone:true});
      fillSelect('machineSel', MACHINES_BY_PAIR[k2(line,sub)]||[], '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Machine --', {allowNone:true});
      syncToolByMachine();
      syncMachineByTool();
      updateSummary();
    });

    toolSel.addEventListener('change', ()=>{
      syncMachineByTool();
      updateSummary();
    });
    machineSel.addEventListener('change', ()=>{
      syncToolByMachine();
      updateSummary();
    });

    ['subject','problem','action','wtStart','wtEnd'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', updateSummary);
      el.addEventListener('change', updateSummary);
    });

    /* ===== ‡∏†‡∏≤‡∏û: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 4 ‡∏£‡∏π‡∏õ, ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏£‡∏∏‡∏õ ===== */
    const picker=$('#mediaPicker'), btnCamera=$('#btnCamera'), btnGallery=$('#btnGallery'), btnClear=$('#btnClearPhotos');
    let files = []; let dataUrls = [];

    function resetPhotos(){
      files = []; dataUrls = [];
      try{ picker.value=''; }catch(e){}
      renderSummaryPhotos();
    }
    function readFilesAndPreview(list){
      const arr = Array.from(list||[]).slice(0,4);
      files = arr; dataUrls = [];
      if (!arr.length){ renderSummaryPhotos(); return; }
      let remain = arr.length;
      arr.forEach((f,idx)=>{
        const fr = new FileReader();
        fr.onload = e=>{
          dataUrls[idx] = e.target.result;
          if (--remain===0) renderSummaryPhotos();
        };
        fr.readAsDataURL(f);
      });
    }
    function renderSummaryPhotos(){
      const grid = $('#sum_photos');
      grid.innerHTML = '';
      const urls = dataUrls.filter(Boolean).slice(0,4);
      if (!urls.length){ grid.style.display='none'; $('#sum_photoNote').textContent='‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ: ‚Äî'; return; }
      urls.forEach(u=>{
        const img=document.createElement('img');
        img.src=u; grid.appendChild(img);
      });
      grid.style.display='grid';
      $('#sum_photoNote').textContent='‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ: ' + urls.length + ' ‡πÑ‡∏ü‡∏•‡πå';
    }

    picker.addEventListener('change', ()=> readFilesAndPreview(picker.files));
    $('#btnCamera').addEventListener('click', ()=>{
      picker.setAttribute('accept','image/*;capture=camera');
      picker.setAttribute('capture','environment');
      picker.click();
    });
    $('#btnGallery').addEventListener('click', ()=>{
      picker.setAttribute('accept','image/*');
      picker.removeAttribute('capture');
      picker.click();
    });
    $('#btnClearPhotos').addEventListener('click', resetPhotos);

    /* ===== Submit / Reset ===== */
    const form = document.getElementById('reportForm');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    function setLoading(v){ submitBtn.disabled=v; resetBtn.disabled=v; submitBtn.textContent=v?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; }

    form.addEventListener('reset', ()=> setTimeout(()=>{ hardResetUI(); },0));

    function hardResetUI(){
      $('#subject').selectedIndex = 0;
      $('#wtStart').value=''; $('#wtEnd').value='';
      $('#problem').value=''; $('#action').value='';

      $('#lineSel').selectedIndex = 0;
      fillSelect('subSel', [], '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Production line ‡∏Å‡πà‡∏≠‡∏ô');
      fillSelect('toolSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});
      fillSelect('machineSel', [], '‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî', {allowNone:true, disabledWhenEmpty:true});

      resetPhotos();
      updateSummary();
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();

      const ws=$('#wtStart').value, we=$('#wtEnd').value;
      if ((ws && !we) || (!ws && we)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Working time ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'); return; }
      if (ws && we && we < ws) { alert('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°'); return; }

      if (!form.checkValidity()){ form.reportValidity(); return; }
      setLoading(true);

      const payload = {
        subject: $('#subject').value.trim(),
        line: $('#lineSel').value,
        subLine: $('#subSel').value,
        tooling: $('#toolSel').value,
        machineName: $('#machineSel').value,
        workingStart: ws || '',
        workingEnd: we || '',
        problem: $('#problem').value.trim(),
        action: $('#action').value.trim(),
        photos: []
      };

      if (files.length){
        dataUrls.slice(0,4).forEach((u,i)=>{
          if (u) payload.photos.push({ name: files[i] ? files[i].name : ('photo'+(i+1)+'.png'), dataUrl: u });
        });
      }

      google.script.run
        .withSuccessHandler((res)=>{
          setLoading(false);
          if (res && res.ok){
            showModal({ ok: true });
            form.reset();
            hardResetUI();
          } else {
            showModal({
              ok: false,
              title: '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              message: (res && res.message) || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
            });
          }
        })
        .withFailureHandler((err)=>{
          setLoading(false);
          showModal({
            ok: false,
            title: '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            message: (err && err.message) || String(err)
          });
        })
        .saveReport(payload);
    });

    updateSummary();
  });

  function updateSummary(){
    const ws=$('#wtStart').value, we=$('#wtEnd').value;
    const wtxt = (ws && we) ? `${ws} - ${we}` : (ws || we || '‚Äî');
    $('#sum_subject').textContent = $('#subject').value || '‚Äî';
    $('#sum_wtime').textContent = wtxt;
    $('#sum_line').textContent = $('#lineSel').value || '‚Äî';
    $('#sum_sub').textContent = $('#subSel').value || '‚Äî';
    $('#sum_tool').textContent = $('#toolSel').value || '‚Äî';
    $('#sum_machine').textContent = $('#machineSel').value || '‚Äî';
    $('#sum_problem').textContent = $('#problem').value || '‚Äî';
    $('#sum_action').textContent = $('#action').value || '‚Äî';
  }
</script>

</body>
</html>
